#!/usr/bin/env php
<?php

/**
 * NatanPHP Framework - CLI Command Line Interface
 * 
 * Proporciona comandos Ãºtiles para el desarrollo con NatanPHP Framework.
 * Incluye comandos para iniciar el servidor de desarrollo, gestionar la base
 * de datos, limpiar cachÃ© y otras tareas de desarrollo.
 * 
 * Comandos disponibles:
 * - serve: Inicia el servidor de desarrollo PHP built-in
 * - version: Muestra la versiÃ³n actual del framework
 * - help: Muestra ayuda sobre comandos disponibles
 * 
 * @package NatanPHP\Console
 * @author Natan PHP Framework
 */

// Verificar que estamos en la raÃ­z del proyecto
if (!file_exists(__DIR__ . '/composer.json')) {
    echo "âŒ Error: Ejecuta este comando desde la raÃ­z del proyecto NatanPHP.\n";
    exit(1);
}

// Cargar autoloader y helpers
require_once __DIR__ . '/vendor/autoload.php';
require_once __DIR__ . '/core/helpers.php';

// Cargar variables de entorno
if (file_exists(__DIR__ . '/.env')) {
    $dotenv = Dotenv\Dotenv::createImmutable(__DIR__);
    $dotenv->load();
}

/**
 * Clase principal para manejar comandos CLI
 */
class NatanCLI
{
    private $command;
    private $args;

    public function __construct($argv)
    {
        $this->command = $argv[1] ?? 'help';
        $this->args = array_slice($argv, 2);
    }

    /**
     * Ejecutar el comando solicitado
     */
    public function run()
    {
        switch ($this->command) {
            case 'serve':
                $this->serve();
                break;
            case 'version':
                $this->version();
                break;
            case 'help':
            case '--help':
            case '-h':
                $this->help();
                break;
            default:
                echo "âŒ Comando desconocido: {$this->command}\n";
                echo "ğŸ’¡ Usa 'php natan help' para ver comandos disponibles.\n";
                exit(1);
        }
    }

    /**
     * Comando serve: Iniciar servidor de desarrollo
     */
    private function serve()
    {
        // Obtener configuraciÃ³n del .env
        $host = $this->args[0] ?? $this->getEnvHost();
        $port = $this->args[1] ?? $this->getEnvPort();
        
        echo "ğŸš€ Iniciando NatanPHP Framework...\n";
        echo "ğŸ“ Servidor: http://{$host}:{$port}\n";
        echo "ğŸ“ Directorio: " . __DIR__ . "\n";
        echo "ğŸ”§ VersiÃ³n: " . version() . "\n";
        echo "âš¡ Router: router.php\n";
        echo "\n";
        
        // Verificar si el puerto estÃ¡ en uso y liberarlo
        $this->checkAndFreePort($port);
        
        echo "ğŸ’¡ Presiona Ctrl+C para detener el servidor\n";
        echo "ğŸŒ Abre http://{$host}:{$port} en tu navegador\n";
        echo str_repeat("=", 50) . "\n";

        // Cambiar al directorio public para encontrar router.php
        $publicDir = __DIR__ . '/public';
        if (!is_dir($publicDir)) {
            echo "âŒ Error: No se encuentra el directorio public/\n";
            echo "ğŸ’¡ AsegÃºrate de ejecutar desde la raÃ­z del proyecto.\n";
            exit(1);
        }
        
        // Cambiar al directorio public y ejecutar servidor
        chdir($publicDir);
        $command = "php -S {$host}:{$port} router.php";
        echo "ğŸ”„ Ejecutando: {$command}\n";
        echo "ğŸ“‚ Directorio: " . getcwd() . "\n";
        echo str_repeat("=", 50) . "\n";
        
        passthru($command);
    }

    /**
     * Verificar si un puerto estÃ¡ en uso y liberarlo si es necesario
     */
    private function checkAndFreePort($port)
    {
        echo "ğŸ” Verificando puerto {$port}...\n";
        
        // Intentar mÃºltiples mÃ©todos para encontrar procesos
        $commands = [
            "lsof -ti:{$port} 2>/dev/null",
            "fuser -n tcp {$port} 2>/dev/null",
            "netstat -tlnp 2>/dev/null | grep :{$port} | awk '{print \$7}' | cut -d'/' -f1"
        ];
        
        $pids = [];
        foreach ($commands as $command) {
            $output = shell_exec($command);
            if (!empty(trim($output ?? ''))) {
                $foundPids = array_filter(explode("\n", trim($output ?? '')));
                foreach ($foundPids as $pid) {
                    $pid = trim($pid);
                    if (!empty($pid) && is_numeric($pid)) {
                        $pids[] = $pid;
                    }
                }
                break; // Si encontramos PIDs con un mÃ©todo, no necesitamos probar otros
            }
        }
        
        if (!empty($pids)) {
            echo "âš ï¸  Puerto {$port} estÃ¡ en uso por " . count($pids) . " proceso(s)\n";
            
            foreach ($pids as $pid) {
                echo "ğŸ”„ Terminando proceso PID: {$pid}\n";
                exec("kill -9 {$pid} 2>/dev/null");
            }
            
            // Esperar un momento para que los puertos se liberen
            echo "â³ Esperando que el puerto se libere...\n";
            sleep(3);
            echo "âœ… Puerto {$port} deberÃ­a estar disponible ahora\n";
        } else {
            echo "âœ… Puerto {$port} disponible\n";
        }
        
        echo "\n";
    }

    /**
     * Comando version: Mostrar versiÃ³n del framework
     */
    private function version()
    {
        echo "ğŸ”– NatanPHP Framework " . version() . "\n";
        echo "ğŸ“… PHP " . PHP_VERSION . "\n";
        echo "ğŸ—ï¸  Framework educativo MVC con separaciÃ³n Web/API\n";
        echo "ğŸ“š FilosofÃ­a: Simplicidad con PropÃ³sito\n";
    }

    /**
     * Comando help: Mostrar ayuda
     */
    private function help()
    {
        echo "ğŸ¯ NatanPHP Framework - CLI Commands\n";
        echo str_repeat("=", 40) . "\n";
        echo "\n";
        echo "ğŸ“‹ Comandos disponibles:\n\n";
        
        echo "  ğŸš€ serve [host] [port]     Iniciar servidor de desarrollo\n";
        echo "                             host: IP del servidor (default: desde .env)\n";
        echo "                             port: Puerto del servidor (default: desde .env)\n";
        echo "                             Ejemplo: php natan serve localhost 8080\n\n";
        
        echo "  ğŸ”– version                 Mostrar versiÃ³n del framework\n\n";
        
        echo "  â“ help                    Mostrar esta ayuda\n\n";
        
        echo "ğŸ’¡ Ejemplos de uso:\n\n";
        echo "  php natan serve            # Usar configuraciÃ³n del .env\n";
        echo "  php natan serve 0.0.0.0    # Acceso desde cualquier IP\n";
        echo "  php natan serve localhost 3000  # Puerto personalizado\n";
        echo "  php natan version          # Ver versiÃ³n del framework\n\n";
        
        echo "ğŸŒ URLs del proyecto:\n";
        $exampleHost = $this->getEnvHost();
        $examplePort = $this->getEnvPort();
        echo "  - Homepage: http://{$exampleHost}:{$examplePort}/\n";
        echo "  - API Info: http://{$exampleHost}:{$examplePort}/api\n";
        echo "  - VersiÃ³n:  http://{$exampleHost}:{$examplePort}/api/version\n";
        echo "  - Health:   http://{$exampleHost}:{$examplePort}/api/health\n\n";
    }

    /**
     * Obtener host desde .env o usar default
     */
    private function getEnvHost(): string
    {
        $appUrl = $_ENV['APP_URL'] ?? 'http://localhost:8000';
        $parsed = parse_url($appUrl);
        return $parsed['host'] ?? 'localhost';
    }

    /**
     * Obtener puerto desde .env o usar default
     */
    private function getEnvPort(): string
    {
        $appUrl = $_ENV['APP_URL'] ?? 'http://localhost:8000';
        $parsed = parse_url($appUrl);
        return $parsed['port'] ?? '8000';
    }
}

// Ejecutar CLI
$cli = new NatanCLI($argv);
$cli->run();